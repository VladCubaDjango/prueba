{% extends "base.html" %}
{% load i18n static admin_urls %}

{% block extrahead %}{{ block.super }}
    <script src="{% url 'admin:jsi18n' %}"></script>
    <script src="{% static 'js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'js/modal_control.js' %}"></script>
    <script src="{% static 'js/cookie.js' %}"></script>
    <script src="{% static 'js/message.js' %}"></script>
    <script src="{% static 'js/api_conection.js' %}"></script>
    <script src="{% static 'js/jquery.modal.min.js' %}"></script>
    {{ form.media }}
{% endblock %}

{% block extrastyle %}{{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static "css/main.css" %}"/>
    <link rel="stylesheet" type="text/css" href="{% static "css/jquery.dataTables.min.css" %}"/>
    <link rel="stylesheet" type="text/css" href="{% static "css/jquery.modal.min.css" %}"/>
{% endblock %}

{% block breadcrumbs_last %}{{ title }}{% endblock %}

{% block content %}



    <div class="results">
        <div class="container">
            <div class="row">
                <div align="right" class="col"><img src="{% static "img/person.png" %}" width="50px" height="50px">
                </div>
                <div align="left" class="col" style="line-height: 47px;">
                    <h1>{{ person_name }}</h1>
                </div>
            </div>
        </div>
        <table id="result_list" class="hover" style="width:100%" data-page-length="30">
            <thead>
            <tr>
                {% for header in operations_headers %}
                    <th scope="col"
                        class="column-{{ header }}">
                        {{ header }}
                    </th>
                {% endfor %}
            </tr>
            </thead>
            <tbody>
            {% for operation in operations %}
                <tr onclick="load_operation({{ operation.id }})" style="cursor:pointer;cursor: hand">
                    <td>{{ operation.datetime|date:"j F Y  g:i A, l"}}</td>
                    <td>{{ operation.type }}</td>
                    <td>{{ operation.amount }} CUP</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <style>
        .loader-container {
            position: relative;
            width: 100px;
            height: 100px;
            margin-bottom: 10px;
            margin-top: 10px;
            margin-left: auto;
            margin-right: auto;
        }

        .loader-container .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            border: solid 4px transparent;
            border-top-color: #79aec8;
            border-left-color: #79aec8;
            border-radius: 50%;
            animation: loader 1.4s linear infinite;
        }

        .loader-container .loader2 {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 70%;
            height: 70%;
            border: solid 4px transparent;
            border-top-color: #417690;
            border-left-color: #417690;
            border-radius: 50%;
            animation: loader2 1.0s linear infinite;
        }

        @keyframes loader {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }
            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        @keyframes loader2 {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }
            100% {
                transform: translate(-50%, -50%) rotate(-360deg);
            }
        }
    </style>


    <script type="text/javascript">

        var links = document.getElementsByTagName("a");
        var link;
        for (var i = 0; links.length; i++) {
            if (links[i].getAttribute("href") === "/people/user/") {
                link = links[i];
                break;
            }
        }
        if (link) {
            link.setAttribute("href", "/people/user/diner/");
            link.innerHTML = "Comensales y Operaciones"
        }
        var breadcrumbs = document.getElementsByClassName("breadcrumbs");
        var list = [];
        for (var i = 0; i < breadcrumbs[0].childNodes.length; i++) {
            list.push(breadcrumbs[0].childNodes[i].cloneNode(true))
        }
        breadcrumbs[0].innerHTML = ""
        breadcrumbs[0].appendChild(list[0]); // <a>Inicio</a>
        breadcrumbs[0].appendChild(list[1]); // >
        {#breadcrumbs[0].appendChild(list[2]); // <a>Personas</a>  #}
        {#breadcrumbs[0].appendChild(list[3]); // >                #}
        breadcrumbs[0].appendChild(list[4]); // <a>Comensales y operaciones</a>
        breadcrumbs[0].appendChild(list[5]); // >
        breadcrumbs[0].appendChild(list[6]); // Operations


        $(document).ready(function () {
            $('#result_list').DataTable({
                "dom": '<"toolbar">frtip',
                "ordering": false,
            });
        });





        async function load_operation(id) {
            res = (await connect_post_backend('/people/user/process-operation/', {'id': id}))
            $('#more_info_operation').modal()
            html = modal_operation_more_info(res)
            showModal("Operación", html, {type: "ok"})
        }

        function format_type(type) {
            if (type == "DB") {
                return "Débito"
            }
            return "Crédito"
        }

        function modal_operation_more_info(info) {

            var options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            };
            var fecha = new Date(info['data']['transactionById']['datetime'])
            var fecha_string = new Intl.DateTimeFormat('es-ES', options).format(fecha)
            html = "<div class=\"container-fluid\">\n" +
                "                <div class=\"row\">\n" +
                "                    <div class=\"col\">\n" +
                "                        <p><b>Nº Folio:</b> " + info['data']['transactionById']['folio'] + "</p>\n" +
                "                    </div>\n" +
                "                    <div class=\"col\" align=\"right\">\n" +
                "                        <cite>" + fecha_string + "</cite>\n" +
                "                    </div>\n" +
                "                </div>\n" +
                "                <div class=\"row\">\n" +
                "                    <div class=\"col\">\n" +
                "                        <p><b>Usuario:</b> " + info['data']['transactionById']['user'] + "</p>\n" +
                "                    </div>\n" +
                "                </div>\n" +
                "                <div class=\"row\">\n" +
                "                    <div class=\"col\">\n" +
                "                        <p><b>Tipo:</b> " + format_type(info['data']['transactionById']['type']) + "</p>\n" +
                "                    </div>\n" +
                "                </div>\n" +
                "                <div class=\"row\">\n" +
                "                    <div class=\"col\">\n" +
                "                        <p><b>Descripción:</b></p>\n" +
                "                        <p style=\"border: solid 4px transparent;border-bottom-color: #111111; border-top-color: #111111;padding-bottom: 16px;padding-top: 10px;\">\n" +
                "                            " + info['data']['transactionById']['description'] + "" +
                "                        </p>\n" +
                "                    </div>\n" +
                "                </div>\n" +
                "                <div class=\"row\">\n" +
                "                    <div class=\"col\">\n" +
                "                        <p><b>Balance Previo:</b> " + info['data']['transactionById']['previousBalance'] + " CUP</p>\n" +
                "                    </div>\n" +
                "                </div>\n" +
                "                <div class=\"row\">\n" +
                "                    <div class=\"col\">\n" +
                "                        <p><b>Balance Resultante:</b> " + info['data']['transactionById']['resultingBalance'] + " CUP</p>\n" +
                "                    </div>\n" +
                "                </div>\n" +
                "                <div class=\"row\">\n" +
                "                    <div class=\"col\">\n" +
                "                        <h1>Monto: " + info['data']['transactionById']['amount'] + " CUP</h1>\n" +
                "                    </div>\n" +
                "                </div>\n" +
                "            </div>"
            return html
        }

    </script>


{% endblock %}